<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Design Patterns - Java Performance Lecture Notes</title>
        
        


        <!-- Custom HTML head -->
        <meta name="author" value="Erik Helleren">

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introductions</a></li><li class="chapter-item expanded "><a href="../../introduction/standards.html"><strong aria-hidden="true">2.</strong> Standards</a></li><li class="chapter-item expanded "><a href="../../introduction/keyTerms.html"><strong aria-hidden="true">3.</strong> Key Terms</a></li><li class="chapter-item expanded affix "><li class="part-title">Theory</li><li class="chapter-item expanded "><a href="../../theory/queueTheory/index.html"><strong aria-hidden="true">4.</strong> Queue Theory</a></li><li class="chapter-item expanded "><a href="../../theory/statsPrimer/index.html"><strong aria-hidden="true">5.</strong> Statistics Primer</a></li><li class="chapter-item expanded "><a href="../../theory/distributionAnalysis/index.html"><strong aria-hidden="true">6.</strong> Distribution analysis</a></li><li class="chapter-item expanded "><a href="../../theory/coordinatedOmission/index.html"><strong aria-hidden="true">7.</strong> Coordinated Omission</a></li><li class="chapter-item expanded affix "><li class="part-title">Hardware</li><li class="chapter-item expanded "><a href="../../hardware/highLevel/index.html"><strong aria-hidden="true">8.</strong> Computer Architecture: High Level</a></li><li class="chapter-item expanded "><a href="../../hardware/cpu.html"><strong aria-hidden="true">9.</strong> Computer Architecture: CPU Design</a></li><li class="chapter-item expanded "><a href="../../hardware/Cache.html"><strong aria-hidden="true">10.</strong> Computer Architecture: Cache, RAM, and Locality</a></li><li class="chapter-item expanded affix "><li class="part-title">Operating System</li><li class="chapter-item expanded "><a href="../../os/refresher/index.html"><strong aria-hidden="true">11.</strong> OS Refresher</a></li><li class="chapter-item expanded "><a href="../../os/numa/index.html"><strong aria-hidden="true">12.</strong> NUMA and Numa Control</a></li><li class="chapter-item expanded "><a href="../../os/scheduler/index.html"><strong aria-hidden="true">13.</strong> Working with the scheduler</a></li><li class="chapter-item expanded affix "><li class="part-title">Java</li><li class="chapter-item expanded "><a href="../../jvm/compile/index.html"><strong aria-hidden="true">14.</strong> Compiling, interpreting, and compiling again</a></li><li class="chapter-item expanded "><a href="../../jvm/jit/index.html"><strong aria-hidden="true">15.</strong> Investigating JIT</a></li><li class="chapter-item expanded "><a href="../../jvm/memory/index.html"><strong aria-hidden="true">16.</strong> Java and Memory</a></li><li class="chapter-item expanded affix "><li class="part-title">Microbenchmarking with JMH</li><li class="chapter-item expanded "><a href="../../micro/micro/index.html"><strong aria-hidden="true">17.</strong> Microbenchmarking</a></li><li class="chapter-item expanded "><a href="../../micro/jmhIntro/index.html"><strong aria-hidden="true">18.</strong> JMH: An introduction</a></li><li class="chapter-item expanded "><a href="../../micro/pitfalls/index.html"><strong aria-hidden="true">19.</strong> Pitfalls</a></li><li class="chapter-item expanded "><a href="../../micro/design/index.html"><strong aria-hidden="true">20.</strong> Designing good benchmarks</a></li><li class="chapter-item expanded "><a href="../../micro/deps/index.html"><strong aria-hidden="true">21.</strong> Dealing with dependencies</a></li><li class="chapter-item expanded "><a href="../../micro/coreProfilers/index.html"><strong aria-hidden="true">22.</strong> Core Profilers</a></li><li class="chapter-item expanded "><a href="../../micro/async/index.html"><strong aria-hidden="true">23.</strong> Async Profiler</a></li><li class="chapter-item expanded "><a href="../../micro/ci/index.html"><strong aria-hidden="true">24.</strong> Integrating into the CI</a></li><li class="chapter-item expanded affix "><li class="part-title">Performance Design Patterns</li><li class="chapter-item expanded "><a href="../../perfDesign/tools/index.html"><strong aria-hidden="true">25.</strong> Tools and Frameworks</a></li><li class="chapter-item expanded "><a href="../../perfDesign/sbe/index.html"><strong aria-hidden="true">26.</strong> Using SBE</a></li><li class="chapter-item expanded "><a href="../../perfDesign/design/index.html" class="active"><strong aria-hidden="true">27.</strong> Design Patterns</a></li><li class="chapter-item expanded "><a href="../../perfDesign/arch/index.html"><strong aria-hidden="true">28.</strong> Architecture Patterns</a></li><li class="chapter-item expanded affix "><li class="part-title">Component level benchmarks</li><li class="chapter-item expanded "><a href="../../comp/design/index.html"><strong aria-hidden="true">29.</strong> Test Design</a></li><li class="chapter-item expanded "><a href="../../comp/tooling/index.html"><strong aria-hidden="true">30.</strong> Available Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/build/index.html"><strong aria-hidden="true">31.</strong> Build Your Own Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/profiling/index.html"><strong aria-hidden="true">32.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../../comp/instrumentation/index.html"><strong aria-hidden="true">33.</strong> Instrumentation</a></li><li class="chapter-item expanded "><a href="../../comp/model/index.html"><strong aria-hidden="true">34.</strong> Modeling</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Java Performance Lecture Notes</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://www.buymeacoffee.com/erik.helleren" title="Buy Me A Coffee" aria-label="Buy Me A Coffe">
                            <i class="fa fa-coffee" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="design-patterns"><a class="header" href="#design-patterns">Design Patterns</a></h1>
<h2 id="do-away-with-shared-mutable-state"><a class="header" href="#do-away-with-shared-mutable-state">Do Away with shared mutable state</a></h2>
<p>Shared mutable state is the enemy of high performance applications.  The larger the scope that the state is shared, the more expensive it is to get a lock (Thread = free, process = Lock/mutex, inter-host = Remote API call).  The more mutable shared state there is, the more likely you are to need to get a lock. And the more interactions that happen between units of shared state, the more complex and expensive lock ordering becomes.  All of this quickly spirals in even the simplest of systems.  Optimistically, a lock on a multisocket machine takes 100's of cycles.  And if remote locks must be obtained, that can reach into hundreds of microseconds easily.</p>
<p>The simplest option is to avoid shared mutable state at every level.  We can do that thru some simple techniques within the process: ThreadLocals and Pipelining.</p>
<h3 id="thread-local"><a class="header" href="#thread-local">Thread local</a></h3>
<p>Java provides a wonderful abstraction for having state local to each thread, <code>ThreadLocal</code>.  From the <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/ThreadLocal.html">java doc</a>:</p>
<blockquote>
<p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. </p>
</blockquote>
<p>The thread local class is actually kind of deceptive because it only serves as a way to access the state.  In reality, each thread maintains a map where the key is an instance of the ThreadLocal object and the value is that threads version of the object in question.  This is critical to understand: <em>Each instance of a ThreadLocal object is used to represent the instances of the object across ALL threads.</em>  You should not create 1 ThreadLocal object per thread.</p>
<p>To use a ThreadLocal, we first need to initialize it.  The below example is creating a ThreadLocal to hold a StringBuilder.  It doesn't actually allocate anything until we first call get in a thread.  If set has not yet been called, the initializer is called and the result is saved on that particular thread.  Given this, it is imperative that your initializer is thread safe.</p>
<pre><code class="language-java">        ThreadLocal&lt;StringBuilder&gt; stringBuilderThreadLocal =
                ThreadLocal.withInitial(StringBuilder::new);
</code></pre>
<p>Another key point from the javadoc:</p>
<blockquote>
<p>Each thread holds an implicit reference to its copy of a thread-local variable as long as the thread is alive and the ThreadLocal instance is accessible; after a thread goes away, all of its copies of thread-local instances are subject to garbage collection (unless other references to these copies exist).</p>
</blockquote>
<p>This means we should be careful with the number of threads we spin up that access a thread local.  While this is fine in most cases, some frameworks spin up thousands of threads to handle blocking requests efficiently.  Thread local may not be appropriate in those contexts.</p>
<h3 id="pipeline"><a class="header" href="#pipeline">Pipeline</a></h3>
<p>The pipeline pattern revolves around breaking the problem up into several distinct steps and doing then in sequence between multiple threads.  Each thread has a queue between it to facilitate communication, represented as arrows below.</p>
<pre class="mermaid">graph LR;
NetworkReader --&gt; ParseMessage;
ParseMessage --&gt; ProcessMessage;
ProcessMessage --&gt; PrepareOutput;
PrepareOutput --&gt; NetworkWriter;
</pre>
<p>It is best practice to have bounded queues.  This allows the application to apply back pressure to previous pipeline steps.  This is much more desirable than running out of memory.  If you need to have an unbounded queue, try to limit it to just the one just after reading from the network.</p>
<p>If you are instrumenting your code manually, its a good idea to capture the time a particular message enters a queue and comes out of one.  If done consistently, this gives you not only the queue time for that event, but also the service time per pipeline stage.</p>
<p>Lastly, while in production we are likely to have queues between these pipeline stages, its good to provide an abstraction here that allows inline processing.  This allows for simplified automated testing.</p>
<p>Replacing the standard queues with a breath-first style of handling messages will flush each pipeline stage one at a time till you get to the end.  This is appropriate both for traditional unit-style tests which are run via a junit in process, and for tests that target a deployed instance.  Having this design can really cut down on testing time and resources.</p>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>We have seen multiple apps that have been cripled by incorrect or improper logging.  The most egregious example was an app that saw a 3x increase in capacity after fixing a single overly verbose trace log that was being evaluated every time in production by accident. </p>
<p>Logging for low latency applications falls down to 3 key principles:</p>
<ol>
<li>Use <a href="https://logging.apache.org/log4j/2.x/manual/garbagefree.html">log4j2</a>.  It is garbage free in the steady state when used correctly.  Log4j2 also has impressive throughput and a huge set of integrations.  Make sure all your logs make use of the garbage free API.</li>
<li>Guard debug and trace logs.  Adding a guard makes JIT's job easier, helping to ensure erasure.  It can also save time when using the box static helper methods.</li>
<li>Limit logging.   Limiting logging is your best defence against log related performance issues.  Only log warnings or higher in the critical path. Demote anything in the critical path that is info to debug or trace.</li>
</ol>
<p>To limit logging, periodically output proof of life logs rather than on every message or event.  Such logs should have some metadata about the work done since the last time the logs ran or from the start of the process.</p>
<h3 id="log4j2s-stringbuilderformatable"><a class="header" href="#log4j2s-stringbuilderformatable">Log4j2's StringBuilderFormatable</a></h3>
<p>Log4j2 allows any object to implement <a href="https://logging.apache.org/log4j/2.x/log4j-api/xref/org/apache/logging/log4j/util/StringBuilderFormattable.html">StringBuilderFormatable</a>, allowing you to pass them without creating any garbage.  Its a single method interface that provides you a StringBuilder to dump your objects state to.</p>
<p>If you use IntelliJ, you can use the toString generator to do most of this work for you.  Just configure the generator to use the stringBuilder pattern, and then copy out the body to the formatTo method, leaving out the instantiation of a new StringBuilder.  Objects that implement StringBuilderFormatable often have this as a toString():</p>
<pre><code class="language-java">public String toString(){
    StringBuilder sb = new StringBuilder();
    this.formatTo(sb);
    return sb.toString();
}
</code></pre>
<h2 id="reuse-and-pool-objects"><a class="header" href="#reuse-and-pool-objects">Reuse and pool objects</a></h2>
<h2 id="off-heap"><a class="header" href="#off-heap">Off Heap</a></h2>
<p>TODO offheap patterns</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../perfDesign/sbe/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../perfDesign/arch/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                    <hr>
                    <div>
                        <p>
                            &copy; Erik Helleren, 2021.  Built on 2021-06-15 from commit <code class="hljs">29e90245</code>. <a href="https://www.buymeacoffee.com/erik.helleren">Buy me a coffee.</a>
                        </p>
                    </div>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../perfDesign/sbe/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../perfDesign/arch/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
