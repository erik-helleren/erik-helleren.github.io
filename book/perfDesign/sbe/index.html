<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using SBE - Java Performance Lecture Notes</title>
        
        


        <!-- Custom HTML head -->
        <meta name="author" value="Erik Helleren">

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introductions</a></li><li class="chapter-item expanded "><a href="../../introduction/standards.html"><strong aria-hidden="true">2.</strong> Standards</a></li><li class="chapter-item expanded "><a href="../../introduction/keyTerms.html"><strong aria-hidden="true">3.</strong> Key Terms</a></li><li class="chapter-item expanded affix "><li class="part-title">Theory</li><li class="chapter-item expanded "><a href="../../theory/queueTheory/index.html"><strong aria-hidden="true">4.</strong> Queue Theory</a></li><li class="chapter-item expanded "><a href="../../theory/statsPrimer/index.html"><strong aria-hidden="true">5.</strong> Statistics Primer</a></li><li class="chapter-item expanded "><a href="../../theory/distributionAnalysis/index.html"><strong aria-hidden="true">6.</strong> Distribution analysis</a></li><li class="chapter-item expanded "><a href="../../theory/coordinatedOmission/index.html"><strong aria-hidden="true">7.</strong> Coordinated Omission</a></li><li class="chapter-item expanded affix "><li class="part-title">Hardware</li><li class="chapter-item expanded "><a href="../../hardware/highLevel/index.html"><strong aria-hidden="true">8.</strong> Computer Architecture: High Level</a></li><li class="chapter-item expanded "><a href="../../hardware/cpu.html"><strong aria-hidden="true">9.</strong> Computer Architecture: CPU Design</a></li><li class="chapter-item expanded "><a href="../../hardware/Cache.html"><strong aria-hidden="true">10.</strong> Computer Architecture: Cache, RAM, and Locality</a></li><li class="chapter-item expanded affix "><li class="part-title">Operating System</li><li class="chapter-item expanded "><a href="../../os/refresher/index.html"><strong aria-hidden="true">11.</strong> OS Refresher</a></li><li class="chapter-item expanded "><a href="../../os/numa/index.html"><strong aria-hidden="true">12.</strong> NUMA and Numa Control</a></li><li class="chapter-item expanded "><a href="../../os/scheduler/index.html"><strong aria-hidden="true">13.</strong> Working with the scheduler</a></li><li class="chapter-item expanded affix "><li class="part-title">Java</li><li class="chapter-item expanded "><a href="../../jvm/compile/index.html"><strong aria-hidden="true">14.</strong> Compiling, interpreting, and compiling again</a></li><li class="chapter-item expanded "><a href="../../jvm/jit/index.html"><strong aria-hidden="true">15.</strong> Investigating JIT</a></li><li class="chapter-item expanded "><a href="../../jvm/memory/index.html"><strong aria-hidden="true">16.</strong> Java and Memory</a></li><li class="chapter-item expanded affix "><li class="part-title">Microbenchmarking with JMH</li><li class="chapter-item expanded "><a href="../../micro/micro/index.html"><strong aria-hidden="true">17.</strong> Microbenchmarking</a></li><li class="chapter-item expanded "><a href="../../micro/jmhIntro/index.html"><strong aria-hidden="true">18.</strong> JMH: An introduction</a></li><li class="chapter-item expanded "><a href="../../micro/pitfalls/index.html"><strong aria-hidden="true">19.</strong> Pitfalls</a></li><li class="chapter-item expanded "><a href="../../micro/design/index.html"><strong aria-hidden="true">20.</strong> Designing good benchmarks</a></li><li class="chapter-item expanded "><a href="../../micro/deps/index.html"><strong aria-hidden="true">21.</strong> Dealing with dependencies</a></li><li class="chapter-item expanded "><a href="../../micro/coreProfilers/index.html"><strong aria-hidden="true">22.</strong> Core Profilers</a></li><li class="chapter-item expanded "><a href="../../micro/async/index.html"><strong aria-hidden="true">23.</strong> Async Profiler</a></li><li class="chapter-item expanded "><a href="../../micro/ci/index.html"><strong aria-hidden="true">24.</strong> Integrating into the CI</a></li><li class="chapter-item expanded affix "><li class="part-title">Performance Design Patterns</li><li class="chapter-item expanded "><a href="../../perfDesign/tools/index.html"><strong aria-hidden="true">25.</strong> Tools and Frameworks</a></li><li class="chapter-item expanded "><a href="../../perfDesign/sbe/index.html" class="active"><strong aria-hidden="true">26.</strong> Using SBE</a></li><li class="chapter-item expanded "><a href="../../perfDesign/design/index.html"><strong aria-hidden="true">27.</strong> Design Patterns</a></li><li class="chapter-item expanded "><a href="../../perfDesign/arch/index.html"><strong aria-hidden="true">28.</strong> Architecture Patterns</a></li><li class="chapter-item expanded affix "><li class="part-title">Component level benchmarks</li><li class="chapter-item expanded "><a href="../../comp/design/index.html"><strong aria-hidden="true">29.</strong> Test Design</a></li><li class="chapter-item expanded "><a href="../../comp/tooling/index.html"><strong aria-hidden="true">30.</strong> Available Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/build/index.html"><strong aria-hidden="true">31.</strong> Build Your Own Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/profiling/index.html"><strong aria-hidden="true">32.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../../comp/instrumentation/index.html"><strong aria-hidden="true">33.</strong> Instrumentation</a></li><li class="chapter-item expanded "><a href="../../comp/model/index.html"><strong aria-hidden="true">34.</strong> Modeling</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Java Performance Lecture Notes</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://www.buymeacoffee.com/erik.helleren" title="Buy Me A Coffee" aria-label="Buy Me A Coffe">
                            <i class="fa fa-coffee" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="using-sbe"><a class="header" href="#using-sbe">Using SBE</a></h1>
<p><a href="https://github.com/real-logic/simple-binary-encoding">Simple Binary Encoding</a> was origionally designed as a low latency, highly parseable binary messaging format for finance, but its usage has grown beyond finance and beyond messaging.  Please take a moment and read the <a href="https://github.com/real-logic/simple-binary-encoding/wiki/Design-Principles">Design principals</a> which drive SBE, and understand how those impact the performance fo the library.</p>
<p>At its heart, SBE implements the the flyweight pattern.  A flyweight, instead of storing its own state, stores it data in a backing array or buffer.  That buffer may have many 'instances' of that object's state.  But we only have the 1 instance of the flyweight.  The flyweight object, in this case the SBE Decoder, gets pointed to a location in that buffer, and told this is where your state starts.   The flyweight object saves that starting point and validates some header information, but thats it.  It does no additionally parsing until you start asking for data.  Each get method translates the starting pointer to where that particular data is in memory, and gets it.</p>
<p>TODO Graphic for this</p>
<h2 id="how-to-build-a-schema"><a class="header" href="#how-to-build-a-schema">How to build a schema</a></h2>
<h2 id="building-good-schemas-and-schema-management"><a class="header" href="#building-good-schemas-and-schema-management">Building good schemas, and schema management</a></h2>
<p>I am not going to dig into the fundamentals of <a href="https://github.com/real-logic/simple-binary-encoding/wiki/FIX-SBE-XML-Primer">how to build a schema</a> or <a href="https://github.com/real-logic/simple-binary-encoding/wiki/Message-Versioning">versioning</a> of schemas. Instead here are some suggestions for designing good templates and managing them effectively.</p>
<h3 id="managing-templates-integrated-into-multiple-projects"><a class="header" href="#managing-templates-integrated-into-multiple-projects">Managing Templates integrated into multiple projects</a></h3>
<p>To keep things simple, there should be 1 single source of truth of ALL templates.  That source should meet these general requirements:</p>
<ol>
<li>Have common types in a shared schema file. This keeps the generated classes cleaner and a little more reusable.</li>
<li>Visible.  Everyone should see them.</li>
<li>Write restricted.  If you normally require 1 approver for a PR, require 2 for this system.  If you don't normally have someone approve a PR, don't use SBE.</li>
<li>Available as XML.  SBE works best when there are just XML files.  This allows differing applications to have different versions of Agrona and the SBE library.</li>
<li>Versioned automatically.  Every change to a schema that makes it to master/release MUST increment the version.</li>
<li>Never break backwards OR forwards compatibility for a template.  Enforce this with a CI that all changes must go thru.  <em>The correct way to make a compatibility breaking change is to create a NEW schema</em>.</li>
<li>Consolidate common sets of data into appropriate types.  Types are free on the wire and nearly free to encode.  Just be sure to be committed, because types can not be changed.  They can only be retired and replaced with new ones.</li>
<li>CI should ensure ID uniqueness.</li>
<li>DO NOT apply this to SBE schemas that stay withing the bounds of a single project (git repo or maven artifact).</li>
<li>Only group templates to the same schema if they must be versioned together. All templates in a schema should be published by a single component, and tightly coupled.  An example would be schemas which have foreign keys into each other.   Versions are set at the schema level, so having granular schemas helps projects avoid unnessicary updates.</li>
</ol>
<p>Following the above principles ensures these properties:</p>
<ul>
<li>Backwards and forwards compatibility always, automatically.  No need for analysis.</li>
<li>Reduced duplicate SBE types, helps to keep parsing code more flexible</li>
<li>Minimizes risk of dependency conflicts because there are no dependencies, just XML files</li>
<li>Easy integration with on the fly decoders.  Just include all the XML files.</li>
<li></li>
</ul>
<p>The above can easily be accomplished with 2 git repos: 1 for the XML files and a second to store the jenkins files and test code to ensure that only valid changes are made.</p>
<h3 id="quick-management-tips"><a class="header" href="#quick-management-tips">Quick Management tips</a></h3>
<table><thead><tr><th>Question</th><th>answer</th></tr></thead><tbody>
<tr><td>Who should design schemas?</td><td>An interdisciplinary team including at least one person who thoroughly understand SBE and how computers work and at least one person who thoroughly understands what information needs to be in the message.  Both should have veto powers.</td></tr>
<tr><td>Should we make the fields as small as possible?</td><td>When picking the data type, go as as small as you can, but no smaller.  Keep in mind that you can not make fields larger later.</td></tr>
<tr><td>Does byte alignment matter?</td><td>Yes, do your best to follow it.  Most situations don't call for alignment beyond the 64 byte block.  Just make sure to include all headers in your calculation.</td></tr>
<tr><td>Should I avoid vardata when possible?</td><td>Yes, especially strings.</td></tr>
<tr><td>Should I avoid strings in favor of numbers and enums?</td><td>Yes</td></tr>
<tr><td>Should I prefer integer data types to floating point data types?</td><td>Yes</td></tr>
<tr><td>I need to know who published a message.  How can I do that?</td><td>Avoid using strings like hostname or application name.  Use numbers that can trivially be looked up: Source IP address as 4 bytes for IPv4 or 8 uint16's for IPv6.  <br>If your application has a component ID saying what type of logical component it is, use that instead of a textual name.(Make sure you have a computer friendly way to do the translation)  <br>Use an instance ID if you have one, or if you are containerized, the GUID of the container's instance.</td></tr>
<tr><td>Does SBE support Inheritance?</td><td>Not really.  Complex Types can be constructed, but migrating to a new version of that type can be a nightmare.  The best option is to nest multiple messages in a single wrapper.</td></tr>
<tr><td>Should I duplicate data on a nested template on an outer template to save time?</td><td>Doing so has no material impact on time when parsing a message, provided the nested data is a regular field and there there aren't many messages in the inner field.  <br>But run tests for your specific messaging scenario.  <br>Any gains on the consumer are often lost on the producer, and larger packets can cause extra network stress</td></tr>
</tbody></table>
<h3 id="message-nesting"><a class="header" href="#message-nesting">Message nesting</a></h3>
<p>Given that SBE is a flyweight pattern, having multiple layers of messages, or having 20 messages that compose a single logical message has minimal overhead.  In fact, having tightly coupled fields close together in memory and on the wire can improve cache efficiency both when building the message and when sending it. </p>
<p>A standard practice is to have a common wrapping template with 1 var data that contains 1 or more business messages.  That wrapper has all the common information you feel that you need for traceability and route-ability for all messages.  Common items like source, destination, and other critical metadata.  Do not put business fields on the wrapper.  Seriously, don't do it.  Also, avoid adding metadata to 'help' parsers, like what type of message is inside.</p>
<p>Within that vardata, we have repeated SBE messages.  In order to support variable data on our nested messages, we have to include a length before each of those messages.  The length, by convention, is the number of bytes AFTER the length to read.  Generally an unsigned short (64k) is large enough for most use cases, but use an int if you are unsure.  You can even have 2 different wrapper templates, one with shorts and one with int's.  Its also critical that we always write out the header of the nested SBE.</p>
<p>Generally, we like to keep nested messages as flat as possible.  If we can use 100% fixed offsets with a fixed number of fields, without having wasted space, do it.  If we need repeated data, prefer to use a repeated group rather than a var data.  Repeated groups can easily be extended over time, by adding new fields.  If we are using this approach to manage multiple messages, we should try to keep the number of messages reasonably small within a single transport as finding the message we are intrested with takes linear time and involves many cache misses most likely.  It also can result in death by headers, as each nested message adds 2-4 bytes for the length and 8 bytes for the header.</p>
<p>A nice advantage of this approach is that this can all be done into a single buffer.  The only thing that we need to adjust once we are done is the size of the vardata on the wrapper. This is truly a 0 copy option when making the message.</p>
<p>One final advantage of this approach is that it works well with the SBE on the fly decoders.</p>
<h3 id="an-alternative-nesting-approach"><a class="header" href="#an-alternative-nesting-approach">An alternative nesting approach</a></h3>
<p>Instead of writing the header information and size before each message, create a repeating group on the transport message with this composite type.</p>
<pre><code class="language-xml">&lt;composite name=&quot;messagePointer&quot; description=&quot;Used as part of a repeating group to construct pointers into the message buffer&quot;&gt;
    &lt;type name=&quot;offset&quot; primitiveType=&quot;uint32&quot; description=&quot;The offset into the vardata where this message starts&quot;&gt;
    &lt;type name=&quot;blockLength&quot; primitiveType=&quot;uint16&quot;/&gt;
    &lt;type name=&quot;templateId&quot; primitiveType=&quot;uint16&quot;/&gt;
    &lt;type name=&quot;schemaId&quot; primitiveType=&quot;uint16&quot;/&gt;
    &lt;type name=&quot;version&quot; primitiveType=&quot;uint16&quot;/&gt;
&lt;/composite&gt;
</code></pre>
<p>This composite acts as a table of contents for the var data, telling consumers where each sub message starts and what type of message it is.  The trade off is that you can't do a 0 copy publish with this approach unless you know exactly how many TOC entries there will be.  To support general encoding, maintain 2 separate buffers, one for the transport message, which is having TOC entries added, and a second for the nested messages.  When completed, copy the nested messages into the vardata of the transport message.</p>
<h3 id="the-meta-decoder"><a class="header" href="#the-meta-decoder">The Meta Decoder</a></h3>
<p>One of the largest operational challenges of managing SBE messages is reading them.  This is where a metadecoder comes in handy.  Following the above principles yields a single trove of all the SBE schema's across the organization.  This repo can then be used with the SBE tool to generate an <a href="https://github.com/real-logic/simple-binary-encoding/wiki/Intermediate-Representation">intermediate representation</a> that the <a href="https://github.com/real-logic/simple-binary-encoding/wiki/Java-OTF-User-Guide">on-the-fly decoder</a> can use to parse messages into a more human friendly format (i.e. JSON). </p>
<p>This artifact can be automatically generated and deployed off of master with confidence, allowing QA and prod support to ALWAYS be able to decode a message trivially.  Once the core trasncoder is implemented (bytes-&gt;json), it becomes easy to add it to many other </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../perfDesign/tools/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../perfDesign/design/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                    <hr>
                    <div>
                        <p>
                            &copy; Erik Helleren, 2021.  Built on 2021-06-15 from commit <code class="hljs">29e90245</code>. <a href="https://www.buymeacoffee.com/erik.helleren">Buy me a coffee.</a>
                        </p>
                    </div>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../perfDesign/tools/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../perfDesign/design/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
