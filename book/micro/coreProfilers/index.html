<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Core Profilers - Java Performance Lecture Notes</title>
        
        


        <!-- Custom HTML head -->
        <meta name="author" value="Erik Helleren">

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introductions</a></li><li class="chapter-item expanded "><a href="../../introduction/standards.html"><strong aria-hidden="true">2.</strong> Standards</a></li><li class="chapter-item expanded "><a href="../../introduction/keyTerms.html"><strong aria-hidden="true">3.</strong> Key Terms</a></li><li class="chapter-item expanded affix "><li class="part-title">Theory</li><li class="chapter-item expanded "><a href="../../theory/queueTheory/index.html"><strong aria-hidden="true">4.</strong> Queue Theory</a></li><li class="chapter-item expanded "><a href="../../theory/statsPrimer/index.html"><strong aria-hidden="true">5.</strong> Statistics Primer</a></li><li class="chapter-item expanded "><a href="../../theory/distributionAnalysis/index.html"><strong aria-hidden="true">6.</strong> Distribution analysis</a></li><li class="chapter-item expanded "><a href="../../theory/coordinatedOmission/index.html"><strong aria-hidden="true">7.</strong> Coordinated Omission</a></li><li class="chapter-item expanded affix "><li class="part-title">Hardware</li><li class="chapter-item expanded "><a href="../../hardware/highLevel/index.html"><strong aria-hidden="true">8.</strong> Computer Architecture: High Level</a></li><li class="chapter-item expanded "><a href="../../hardware/cpu.html"><strong aria-hidden="true">9.</strong> Computer Architecture: CPU Design</a></li><li class="chapter-item expanded "><a href="../../hardware/Cache.html"><strong aria-hidden="true">10.</strong> Computer Architecture: Cache, RAM, and Locality</a></li><li class="chapter-item expanded affix "><li class="part-title">Operating System</li><li class="chapter-item expanded "><a href="../../os/refresher/index.html"><strong aria-hidden="true">11.</strong> OS Refresher</a></li><li class="chapter-item expanded "><a href="../../os/numa/index.html"><strong aria-hidden="true">12.</strong> NUMA and Numa Control</a></li><li class="chapter-item expanded "><a href="../../os/scheduler/index.html"><strong aria-hidden="true">13.</strong> Working with the scheduler</a></li><li class="chapter-item expanded affix "><li class="part-title">Java</li><li class="chapter-item expanded "><a href="../../jvm/compile/index.html"><strong aria-hidden="true">14.</strong> Compiling, interpreting, and compiling again</a></li><li class="chapter-item expanded "><a href="../../jvm/jit/index.html"><strong aria-hidden="true">15.</strong> Investigating JIT</a></li><li class="chapter-item expanded "><a href="../../jvm/memory/index.html"><strong aria-hidden="true">16.</strong> Java and Memory</a></li><li class="chapter-item expanded affix "><li class="part-title">Microbenchmarking with JMH</li><li class="chapter-item expanded "><a href="../../micro/micro/index.html"><strong aria-hidden="true">17.</strong> Microbenchmarking</a></li><li class="chapter-item expanded "><a href="../../micro/jmhIntro/index.html"><strong aria-hidden="true">18.</strong> JMH: An introduction</a></li><li class="chapter-item expanded "><a href="../../micro/pitfalls/index.html"><strong aria-hidden="true">19.</strong> Pitfalls</a></li><li class="chapter-item expanded "><a href="../../micro/design/index.html"><strong aria-hidden="true">20.</strong> Designing good benchmarks</a></li><li class="chapter-item expanded "><a href="../../micro/deps/index.html"><strong aria-hidden="true">21.</strong> Dealing with dependencies</a></li><li class="chapter-item expanded "><a href="../../micro/coreProfilers/index.html" class="active"><strong aria-hidden="true">22.</strong> Core Profilers</a></li><li class="chapter-item expanded "><a href="../../micro/async/index.html"><strong aria-hidden="true">23.</strong> Async Profiler</a></li><li class="chapter-item expanded "><a href="../../micro/ci/index.html"><strong aria-hidden="true">24.</strong> Integrating into the CI</a></li><li class="chapter-item expanded affix "><li class="part-title">Performance Design Patterns</li><li class="chapter-item expanded "><a href="../../perfDesign/tools/index.html"><strong aria-hidden="true">25.</strong> Tools and Frameworks</a></li><li class="chapter-item expanded "><a href="../../perfDesign/sbe/index.html"><strong aria-hidden="true">26.</strong> Using SBE</a></li><li class="chapter-item expanded "><a href="../../perfDesign/design/index.html"><strong aria-hidden="true">27.</strong> Design Patterns</a></li><li class="chapter-item expanded "><a href="../../perfDesign/arch/index.html"><strong aria-hidden="true">28.</strong> Architecture Patterns</a></li><li class="chapter-item expanded affix "><li class="part-title">Component level benchmarks</li><li class="chapter-item expanded "><a href="../../comp/design/index.html"><strong aria-hidden="true">29.</strong> Test Design</a></li><li class="chapter-item expanded "><a href="../../comp/tooling/index.html"><strong aria-hidden="true">30.</strong> Available Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/build/index.html"><strong aria-hidden="true">31.</strong> Build Your Own Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/profiling/index.html"><strong aria-hidden="true">32.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../../comp/instrumentation/index.html"><strong aria-hidden="true">33.</strong> Instrumentation</a></li><li class="chapter-item expanded "><a href="../../comp/model/index.html"><strong aria-hidden="true">34.</strong> Modeling</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Java Performance Lecture Notes</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://www.buymeacoffee.com/erik.helleren" title="Buy Me A Coffee" aria-label="Buy Me A Coffe">
                            <i class="fa fa-coffee" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="core-profilers"><a class="header" href="#core-profilers">Core Profilers</a></h1>
<p>JVM ships with several general purpose profilers that can give us some useful data about our benchmarked code.  We can enable as many profilers as we want on a run.  All the profilers are attached to the same run, so this does not impact the run time of our benchmarks.</p>
<h2 id="gc-profiler"><a class="header" href="#gc-profiler">GC profiler</a></h2>
<p>The GC profiler hooks into the standard mBeans to track allocations and garbage collection behavior.  Enabled by simply adding <code>-prof gc</code> to your command line, it does not take any configuration/arguments. The output varies not only based on which garbage collector is in use, but also the behavior of your application. Below is some sample output.</p>
<pre><code>Benchmark                                            Mode  Cnt     Score   Error   Units
Intro_2.testMethod                                   avgt         20.783           ns/op
Intro_2.testMethod:·gc.alloc.rate                    avgt       9336.294          MB/sec
Intro_2.testMethod:·gc.alloc.rate.norm               avgt        224.016            B/op
Intro_2.testMethod:·gc.churn.G1_Eden_Space           avgt       9377.543          MB/sec
Intro_2.testMethod:·gc.churn.G1_Eden_Space.norm      avgt        225.006            B/op
Intro_2.testMethod:·gc.churn.G1_Survivor_Space       avgt          0.072          MB/sec
Intro_2.testMethod:·gc.churn.G1_Survivor_Space.norm  avgt          0.002            B/op
Intro_2.testMethod:·gc.count                         avgt        162.000          counts
Intro_2.testMethod:·gc.time                          avgt         93.000              ms
</code></pre>
<p>An important thing to note, is that this is measured around each iteration.  So if you have an invocation setup or teardown, that will be measured just the same.</p>
<p>Typically we look to the normalized variants which are averaged to be per operation.  We should though keep an eye out on <code>gc.aloc.rate</code>, as java has a limited allocation rate.  This can tell us if our benchmark is measuring what we expected or if its really just measuring the speed of java's allocation.</p>
<p>In our example we can see that we are using the G1 garbage collector, and almost all of our allocations are not promoted to the survivor space.  This implies all of our allocations are short lived.  Is that what we expected?  Lets look at our benchmark</p>
<pre><code class="language-java">    @Benchmark
    public Map&lt;String, Integer&gt; testMethod() {
        Map&lt;String, Integer&gt; myMap = new HashMap&lt;&gt;();
        myMap.put(&quot;a&quot;,1);
        myMap.put(&quot;b&quot;,2);
        myMap.put(&quot;c&quot;,3);
        return myMap;
    }
</code></pre>
<p>So that behavior aligns with our expectation.</p>
<p>The other intreating bits of data for the GC profiler is the count of GC's and the time spent by the garbage collector in ms.  These pauses are measured in our benchmark if we use average time and can significantly skew results.  The question now is, is that skew valid?</p>
<p>Generally, tests which involve allocations should default to relying on Sample time rather than average time to capture the impact of GC on the distribution more clearly.</p>
<h2 id="compilation-basic-data"><a class="header" href="#compilation-basic-data">Compilation: Basic data</a></h2>
<p>As touched on in the JVM chapters, hotspot compiles our code in other threads.  It does so in phases.  Like the GC profiler, just adding <code>-prof comp</code> to the command line enables the profiler and it does not take any configuration.  Here is some sample output.</p>
<pre><code>Benchmark                                   Mode  Cnt    Score   Error  Units
Intro_2.testMethod                          avgt        20.488          ns/op
Intro_2.testMethod:·compiler.time.profiled  avgt         4.000             ms
Intro_2.testMethod:·compiler.time.total     avgt       169.000             ms
</code></pre>
<p>Here we see that the JVM spent a whopping 169 ms compiling code at runtime.  JMH directly does not have more detailed numbers, but you can enable compiler logs in the benchmark using <code>@Fork(1,jvmArgs={&quot;-XX:+UnlockDiagnosticVMOptions&quot;,&quot;-XX:+LogCompilation&quot;}</code>.</p>
<h2 id="pauses-profiler"><a class="header" href="#pauses-profiler">Pauses profiler</a></h2>
<p>Garbage collection isn't the only cause of pauses in the JVM, and the GC profiler doesn't really provide detailed information about GC pauses.   This is where pauses profiler comes in.  Enable using <code>-prof pauses</code>, and it will produce a histogram of all the JVM pauses that happen during the test's iteration.</p>
<pre><code>Benchmark                           Mode  Cnt    Score   Error  Units
Intro_2.testMethod                  avgt        20.928          ns/op
Intro_2.testMethod:·pauses          avgt  170   82.351             ms
Intro_2.testMethod:·pauses.avg      avgt         0.484             ms
Intro_2.testMethod:·pauses.count    avgt       170.000              #
Intro_2.testMethod:·pauses.p0.00    avgt         0.116             ms
Intro_2.testMethod:·pauses.p0.50    avgt         0.493             ms
Intro_2.testMethod:·pauses.p0.90    avgt         0.602             ms
Intro_2.testMethod:·pauses.p0.95    avgt         0.639             ms
Intro_2.testMethod:·pauses.p0.99    avgt         0.746             ms
Intro_2.testMethod:·pauses.p0.999   avgt         0.801             ms
Intro_2.testMethod:·pauses.p0.9999  avgt         0.801             ms
Intro_2.testMethod:·pauses.p1.00    avgt         0.801             ms
</code></pre>
<p>While this profiler does have some configuration, its not advisable to change it.</p>
<h2 id="safepoints"><a class="header" href="#safepoints">Safepoints</a></h2>
<p>Imagine we are measuring code that is working with a file, a lock, networking, or anything else that is considered a safe point.  All safepoints involve some level of waiting, and thats what the safepoints profiler measures.  This can be enabled using <code>-prof safepoints</code> and does not take configuration.</p>
<h2 id="stack"><a class="header" href="#stack">Stack</a></h2>
<p>The stack profiler is the poor man's profiler.  JMH will periodically take a stacktrace of your benchmarking threads, and see where most of the time is being spent.  enabled with <code>-prof stack</code> it is configurable.  Run with <code>-prof stack:help</code> for all the details.</p>
<h2 id="perf"><a class="header" href="#perf">Perf</a></h2>
<p>Unlike the profilers we have discussed so far, perf is limited to just linux operating systems.  Perf inspects the hardware counters of the CPU that ran the benchmark code, and exports that data for you to see.  So, what are in these counters?</p>
<p>Taken from the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/developer_guide/perf-using">redhat documentation</a>, they are counters covering many of the things we covered in both the hardware and OS chapters.  They can include:</p>
<ul>
<li>Cache misses by level</li>
<li>Page faults</li>
<li>Branches taken and misses</li>
<li>TLB loads and misses</li>
<li>Instructions</li>
<li>Context switches</li>
</ul>
<p>Available counters are hardware and OS dependant.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../micro/deps/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../micro/async/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                    <hr>
                    <div>
                        <p>
                            &copy; Erik Helleren, 2021.  Built on 2021-06-15 from commit <code class="hljs">29e90245</code>. <a href="https://www.buymeacoffee.com/erik.helleren">Buy me a coffee.</a>
                        </p>
                    </div>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../micro/deps/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../micro/async/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
