<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Pitfalls - Java Performance Lecture Notes</title>
        
        


        <!-- Custom HTML head -->
        <meta name="author" value="Erik Helleren">

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Introduction</li><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introductions</a></li><li class="chapter-item expanded "><a href="../../introduction/standards.html"><strong aria-hidden="true">2.</strong> Standards</a></li><li class="chapter-item expanded "><a href="../../introduction/keyTerms.html"><strong aria-hidden="true">3.</strong> Key Terms</a></li><li class="chapter-item expanded affix "><li class="part-title">Theory</li><li class="chapter-item expanded "><a href="../../theory/queueTheory/index.html"><strong aria-hidden="true">4.</strong> Queue Theory</a></li><li class="chapter-item expanded "><a href="../../theory/statsPrimer/index.html"><strong aria-hidden="true">5.</strong> Statistics Primer</a></li><li class="chapter-item expanded "><a href="../../theory/distributionAnalysis/index.html"><strong aria-hidden="true">6.</strong> Distribution analysis</a></li><li class="chapter-item expanded "><a href="../../theory/coordinatedOmission/index.html"><strong aria-hidden="true">7.</strong> Coordinated Omission</a></li><li class="chapter-item expanded affix "><li class="part-title">Hardware</li><li class="chapter-item expanded "><a href="../../hardware/highLevel/index.html"><strong aria-hidden="true">8.</strong> Computer Architecture: High Level</a></li><li class="chapter-item expanded "><a href="../../hardware/cpu.html"><strong aria-hidden="true">9.</strong> Computer Architecture: CPU Design</a></li><li class="chapter-item expanded "><a href="../../hardware/Cache.html"><strong aria-hidden="true">10.</strong> Computer Architecture: Cache, RAM, and Locality</a></li><li class="chapter-item expanded affix "><li class="part-title">Operating System</li><li class="chapter-item expanded "><a href="../../os/refresher/index.html"><strong aria-hidden="true">11.</strong> OS Refresher</a></li><li class="chapter-item expanded "><a href="../../os/numa/index.html"><strong aria-hidden="true">12.</strong> NUMA and Numa Control</a></li><li class="chapter-item expanded "><a href="../../os/scheduler/index.html"><strong aria-hidden="true">13.</strong> Working with the scheduler</a></li><li class="chapter-item expanded affix "><li class="part-title">Java</li><li class="chapter-item expanded "><a href="../../jvm/compile/index.html"><strong aria-hidden="true">14.</strong> Compiling, interpreting, and compiling again</a></li><li class="chapter-item expanded "><a href="../../jvm/jit/index.html"><strong aria-hidden="true">15.</strong> Investigating JIT</a></li><li class="chapter-item expanded "><a href="../../jvm/memory/index.html"><strong aria-hidden="true">16.</strong> Java and Memory</a></li><li class="chapter-item expanded affix "><li class="part-title">Microbenchmarking with JMH</li><li class="chapter-item expanded "><a href="../../micro/micro/index.html"><strong aria-hidden="true">17.</strong> Microbenchmarking</a></li><li class="chapter-item expanded "><a href="../../micro/jmhIntro/index.html"><strong aria-hidden="true">18.</strong> JMH: An introduction</a></li><li class="chapter-item expanded "><a href="../../micro/pitfalls/index.html" class="active"><strong aria-hidden="true">19.</strong> Pitfalls</a></li><li class="chapter-item expanded "><a href="../../micro/design/index.html"><strong aria-hidden="true">20.</strong> Designing good benchmarks</a></li><li class="chapter-item expanded "><a href="../../micro/deps/index.html"><strong aria-hidden="true">21.</strong> Dealing with dependencies</a></li><li class="chapter-item expanded "><a href="../../micro/coreProfilers/index.html"><strong aria-hidden="true">22.</strong> Core Profilers</a></li><li class="chapter-item expanded "><a href="../../micro/async/index.html"><strong aria-hidden="true">23.</strong> Async Profiler</a></li><li class="chapter-item expanded "><a href="../../micro/ci/index.html"><strong aria-hidden="true">24.</strong> Integrating into the CI</a></li><li class="chapter-item expanded affix "><li class="part-title">Performance Design Patterns</li><li class="chapter-item expanded "><a href="../../perfDesign/tools/index.html"><strong aria-hidden="true">25.</strong> Tools and Frameworks</a></li><li class="chapter-item expanded "><a href="../../perfDesign/design/index.html"><strong aria-hidden="true">26.</strong> Design Patterns</a></li><li class="chapter-item expanded "><a href="../../perfDesign/arch/index.html"><strong aria-hidden="true">27.</strong> Architecture Patterns</a></li><li class="chapter-item expanded affix "><li class="part-title">Component level benchmarks</li><li class="chapter-item expanded "><a href="../../comp/design/index.html"><strong aria-hidden="true">28.</strong> Test Design</a></li><li class="chapter-item expanded "><a href="../../comp/tooling/index.html"><strong aria-hidden="true">29.</strong> Available Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/build/index.html"><strong aria-hidden="true">30.</strong> Build Your Own Tooling</a></li><li class="chapter-item expanded "><a href="../../comp/profiling/index.html"><strong aria-hidden="true">31.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="../../comp/instrumentation/index.html"><strong aria-hidden="true">32.</strong> Instrumentation</a></li><li class="chapter-item expanded "><a href="../../comp/model/index.html"><strong aria-hidden="true">33.</strong> Modeling</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Java Performance Lecture Notes</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://www.buymeacoffee.com/erik.helleren" title="Buy Me A Coffee" aria-label="Buy Me A Coffe">
                            <i class="fa fa-coffee" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="jmh-pitfalls"><a class="header" href="#jmh-pitfalls">JMH: Pitfalls</a></h1>
<p>JHM has a lot of pitfalls, and we are going to call out a few things to pay special attention to before you go off writing your first JMH microbenchmarks.</p>
<h2 id="scope-is-too-small"><a class="header" href="#scope-is-too-small">Scope is too small</a></h2>
<p>Given that the word micro is in the name, we may be tempted to try to make them as small as can be.  Testing tiny scopes of code like appending to a buffer, or sorting an array thats 2 elements. So, how do we know when we cross that line?</p>
<p>The time can be a good hint.  Lets say multi-unit benchmark, which covers the time it takes to fully process some unit of work and send its result downstream is \(t\).  In general, the unit we are benchmarking accounts for less than \(\frac{t}{10}\) time we should be skeptical that we our unit to benchmark is large enough.  That is aggregrated across all calls to our unit though.  So if we have many calls to that unit, a smaller scope may be appropriate.  But even then, very small scopes can cause problems.</p>
<h2 id="loosing-sight-of-the-bigger-picture"><a class="header" href="#loosing-sight-of-the-bigger-picture">Loosing sight of the bigger picture</a></h2>
<p>Related to the scope being too small.  Sometimes we just lose sight of whats really going on in the system.  Microbenchmarking some edge case, or something we expect to happen very rarely can be counter productive.</p>
<h2 id="not-knowing-what-you-want-to-measure"><a class="header" href="#not-knowing-what-you-want-to-measure">Not knowing what you want to measure</a></h2>
<p>JMH is a tool to run experiments, in the same way that chemistry lab is setup to run chemistry experiments.  It still requires a thoughtful scientist to design meaningful experiments and interpret results.  Most of all, that scientist must question their methods and conclusions.  This puts a lot of responsibility on you, as the scientist!</p>
<p>If you feel that its helpful, write up what you are trying to measure before you start working on the benchmarks.  Have a review after you are done by a co-worker to validate that your benchmark is doing what you expect.  Convert the numbers into meaningful conclusions and, again, get them validated by a peer.</p>
<p>Often times, we aren't trying to optimize just for response time, but also variability.  Things like allocations can cause garbage collection pauses down the line.  High variability in the run time of your applications code can cause erratic queuing time behavior.</p>
<h2 id="measuring-external-systems"><a class="header" href="#measuring-external-systems">Measuring external systems</a></h2>
<p>JMH is designed to measure the time it takes for a method to execute.  If that method depends on a remote service, or makes a blocking network call, that can invalidate results.  Tests like this are best run as component or integration benchmarks rather than microbenchmarks.</p>
<p>If you feel the need to execute these as microbenchmarks, try to insert a mocked service into the code path to avoid the network call.  If you really need the network call, deploy a dedicated instance of the service locally.</p>
<h2 id="measuring-queues-by-accident"><a class="header" href="#measuring-queues-by-accident">Measuring queues by accident</a></h2>
<p>Microbenchmarks excel at directly measuring service time of our code.  But once we introduce multiple threads working in concert in a pipeline, we stop measuring service time and start to measure response time.  This is because there must be a queue between the two threads.  Typically this is a sizeable queue, but evn if its one element, our benchmark is going to behave in a wonky way.</p>
<p>Lets first look at a queue depth of 1. When we have a queue depth of 1, our caller will have to block when it attempts to enqueue the item, or drop it.</p>
<pre class="mermaid">sequenceDiagram
    participant BenchmarkThread
    participant Queue
    participant WorkerThread
    note right of BenchmarkThread: Start Sample 1
    loop Enqueue Item1
        BenchmarkThread-&gt;&gt;Queue: Item 1
    end
    note right of BenchmarkThread: End Sample 1
    note right of BenchmarkThread: Start Sample 2
    loop Enqueue Item2
        BenchmarkThread-&gt;&gt;Queue: Item 2
    end
    WorkerThread-&gt;&gt;Queue: Get Item 1
    note right of BenchmarkThread: End Sample 2
    note right of BenchmarkThread: Start Sample 3
    loop Enqueue Item3
        BenchmarkThread-&gt;&gt;Queue: Item 3
    end
    WorkerThread-&gt;&gt;WorkerThread: doing work
    WorkerThread-&gt;&gt;Queue: Get Item 2
    note right of BenchmarkThread: End Sample 3



</pre>
<p>Above we see a sequence diagram where our queue size is 1.  Our first sample is just the service time of the queue, so we got very lucky. Our second sample got slightly unlucky, and the queue was full when it got there and needed to block, waiting for space to free up.  Which happens when the worker thread gets the first item from the queue.  Sample 3 got the most unlucky, which had to wait for not only all of the work for item 1 to be completed, but also for a fetch from the queue.</p>
<p>But of course, there is some time between our samples, especially if we have a setup or tear down at the invocation level.  Even then JMH does stuff between invocations in addition to our code.  So we have no way of directly measuring work time </p>
<p>So, in our simple queuing example, what do we end up measuring exactly?  Its not queue time, as we don't know the time between when Item 1 is put into the queue and when its removed from the queue.  Very specifically, we are measuring response time with an unknown interarrival behavior at a known average interarrival rate.  We will touch on this in our macro benchmarks chapters, but suffice to say, that is probably not what we are looking for. </p>
<p>If we need to measure the service time of the first thread of a multi-thread pipeline, we can do that in a way thats likely to produce valid results.  We need to only do 3 things:</p>
<ol>
<li>Make our measurement iterations short enough such that they never fill up the queue.  Compensating by having more measurement iterations.</li>
<li>Make the queue large.</li>
<li>Make sure you flush the queue in a <code>@TearDown(Level.Iteration)</code> method.  This ensures the queue doesn't fill up between runs.</li>
</ol>
<p>If you are measuring a 3rd party library that doesn't expose a flush operation, our options are a little more limited.  A last ditch can be to have a sleep timer in the teardown method, but finding the right time to sleep is its own experimental adventure!</p>
<h2 id="steady-state"><a class="header" href="#steady-state">Steady state</a></h2>
<p>Aleksey Shipilëv puts it best in his blog Nanotrusting nanotime, in section <a href="https://shipilev.net/blog/2014/nanotrusting-nanotime/#_steady_state_considerations">Steady State Considerations</a>.  We have to be careful about what state is kept around between iterations.  This is true of any unit or set of units that we are benchmarking which have their own state.</p>
<p>We have three practical options for managing this:</p>
<ol>
<li>Shorten the measurement time significantly.  This doesn't really solve the problem, but for complexity that gros linearly, it can minimize the problem.</li>
<li>Manually reset the state in the benchmark itself.  If the benchmark is very long, a <code>@TearDown(Level.Invocation)</code> method may make sense.  But baselineing the reset may be difficult, especially if it isn't constant time.</li>
<li>Reverse the action taken.  If you are implementing the <a href="https://en.wikipedia.org/wiki/Command_pattern">command design pattern</a> you may be able to undo or reverse the actions the benchmark took faster than it would be to fully reset the object.  Even without applying the command pattern, many systems can have the reverse transaction done.</li>
<li>Probabilistically steady-ish state. Create a set of input data which is net-0 and iterate it thru it.  This prevents the state from diverging uncontrollably.</li>
<li>Clone a known state at the start of each benchmark run.  While sometimes expensive, each run has the exact same data and this is very easy to baseline.</li>
</ol>
<p>With that said, we may WANT to see what happens as our object gets saturated with more and more and more state.  Thinking of the Fibonachi example seen below, we have some options.</p>
<p><img src="shipilev-fibo.svg" alt="Credit to Aleksey Shipilëv" /></p>
<p>JMH is not a great tool for this though.</p>
<p>TODO figure this one out</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../micro/jmhIntro/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../micro/design/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                    <hr>
                    <div>
                        <p>
                            &copy; Erik Helleren, 2021.  Built on 2021-06-08 from commit <code class="hljs">1d1210ef</code>. <a href="https://www.buymeacoffee.com/erik.helleren">Buy me a coffee.</a>
                        </p>
                    </div>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../micro/jmhIntro/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../micro/design/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
